<div class="n8n-chat-widget" [style]="widgetStyles">
  <!-- Toggle Button -->
  <button 
    class="chat-toggle" 
    [class]="positionClass"
    (click)="toggleWidget()"
    [attr.aria-label]="'Abrir chat'">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M12 2C6.477 2 2 6.477 2 12c0 1.821.487 3.53 1.338 5L2.5 21.5l4.5-.838A9.955 9.955 0 0012 22c5.523 0 10-4.477 10-10S17.523 2 12 2zm0 18c-1.476 0-2.886-.313-4.156-.878l-3.156.586.586-3.156A7.962 7.962 0 014 12c0-4.411 3.589-8 8-8s8 3.589 8 8-3.589 8-8 8z"/>
    </svg>
  </button>

  <!-- Chat Container -->
  <div 
    class="chat-container" 
    [class]="positionClass"
    [class.open]="isOpen">
    
    <!-- New Conversation View -->
    <div class="new-conversation" *ngIf="!showChatInterface">
      <div class="brand-header">
        <img [src]="config.branding.logo" [alt]="config.branding.name" />
        <span>{{ config.branding.name }}</span>
        <button class="close-button" (click)="closeWidget()" [attr.aria-label]="'Cerrar chat'">
          ×
        </button>
      </div>
      
      <div class="welcome-content">
        <h2 class="welcome-text">{{ config.branding.welcomeText }}</h2>
        <button 
          class="new-chat-btn" 
          (click)="startNewChat()"
          [disabled]="isLoading">
          <svg class="message-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path fill="currentColor" d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.2L4 17.2V4h16v12z"/>
          </svg>
          <span *ngIf="!isLoading">Envíanos un mensaje</span>
          <span *ngIf="isLoading">Iniciando...</span>
        </button>
        <p class="response-text">{{ config.branding.responseTimeText }}</p>
      </div>
    </div>

    <!-- Chat Interface -->
    <div class="chat-interface" *ngIf="showChatInterface">
      <div class="brand-header">
        <img [src]="config.branding.logo" [alt]="config.branding.name" />
        <span>{{ config.branding.name }}</span>
        <button class="close-button" (click)="closeWidget()" [attr.aria-label]="'Cerrar chat'">
          ×
        </button>
      </div>

      <!-- Messages Container -->
      <div class="chat-messages" #messagesContainer>
        <div 
          *ngFor="let message of messages" 
          class="chat-message"
          [class.user]="message.isUser"
          [class.bot]="!message.isUser">
          {{ message.content }}
        </div>
        
        <!-- Loading indicator -->
        <div *ngIf="isLoading" class="chat-message bot loading">
          <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>

      <!-- Input Container -->
      <div class="chat-input">
        <textarea 
          #messageInput
          [value]="currentMessage"
          (input)="currentMessage = $any($event.target).value"
          placeholder="Escribe tu mensaje aquí..."
          rows="1"
          (keypress)="onKeyPress($event)"
          [disabled]="isLoading">
        </textarea>
        <button 
          type="button" 
          (click)="sendMessage()"
          [disabled]="!currentMessage.trim() || isLoading">
          Enviar
        </button>
      </div>

      <!-- Footer -->
      <div class="chat-footer">
        <a [href]="config.branding.poweredBy.link" target="_blank">
          {{ config.branding.poweredBy.text }}
        </a>
      </div>
    </div>
  </div>
</div>